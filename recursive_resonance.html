<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recursive Resonance: The Context Window</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Lora:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Anthropic Brand Colors */
        :root {
            --anthropic-dark: #141413;
            --anthropic-light: #faf9f5;
            --anthropic-mid-gray: #b0aea5;
            --anthropic-light-gray: #e8e6dc;
            --anthropic-orange: #d97757;
            --anthropic-blue: #6a9bcc;
            --anthropic-green: #788c5d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--anthropic-light) 0%, #f5f3ee 100%);
            min-height: 100vh;
            color: var(--anthropic-dark);
        }

        .container {
            display: flex;
            min-height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(20, 20, 19, 0.1);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar h1 {
            font-family: 'Lora', serif;
            font-size: 24px;
            font-weight: 500;
            color: var(--anthropic-dark);
            margin-bottom: 8px;
        }

        .sidebar .subtitle {
            color: var(--anthropic-mid-gray);
            font-size: 14px;
            margin-bottom: 32px;
            line-height: 1.4;
        }

        /* Control Sections */
        .control-section {
            margin-bottom: 32px;
        }

        .control-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--anthropic-dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-section h3::before {
            content: '•';
            color: var(--anthropic-orange);
            font-weight: bold;
        }

        /* Seed Controls */
        .seed-input {
            width: 100%;
            background: var(--anthropic-light);
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--anthropic-light-gray);
            text-align: center;
        }

        .seed-input:focus {
            outline: none;
            border-color: var(--anthropic-orange);
            box-shadow: 0 0 0 2px rgba(217, 119, 87, 0.1);
            background: white;
        }

        .seed-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .regen-button {
            margin-bottom: 0;
        }

        /* Parameter Controls */
        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--anthropic-dark);
            margin-bottom: 8px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 4px;
            background: var(--anthropic-light-gray);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--anthropic-orange);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: #c86641;
        }

        .slider-container input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--anthropic-orange);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .value-display {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--anthropic-mid-gray);
            min-width: 60px;
            text-align: right;
        }

        /* Color Pickers */
        .color-group {
            margin-bottom: 16px;
        }

        .color-group label {
            display: block;
            font-size: 12px;
            color: var(--anthropic-mid-gray);
            margin-bottom: 4px;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-picker-container input[type="color"] {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: none;
            padding: 0;
        }

        .color-value {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--anthropic-mid-gray);
        }

        /* Buttons */
        .button {
            background: var(--anthropic-orange);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .button:hover {
            background: #c86641;
            transform: translateY(-1px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: var(--anthropic-blue);
        }

        .button.secondary:hover {
            background: #5a8bb8;
        }

        .button.tertiary {
            background: var(--anthropic-green);
        }

        .button.tertiary:hover {
            background: #6b7b52;
        }

        .button-row {
            display: flex;
            gap: 8px;
        }

        .button-row .button {
            flex: 1;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }

        #canvas-container {
            width: 100%;
            max-width: 1000px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(20, 20, 19, 0.1);
            background: white;
        }

        #canvas-container canvas {
            display: block;
            width: 100% !important;
            height: auto !important;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--anthropic-mid-gray);
        }

        /* Responsive - Stack on mobile */
        @media (max-width: 600px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .canvas-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Control Sidebar -->
        <div class="sidebar">
            <h1>Recursive Resonance</h1>
            <div class="subtitle">Visualizing the accumulation of context in Large Language Models.</div>

            <!-- Seed Section -->
            <div class="control-section">
                <h3>Seed</h3>
                <input type="number" id="seed-input" class="seed-input" value="12345" onchange="updateSeed()">
                <div class="seed-controls">
                    <button class="button secondary" onclick="previousSeed()">← Prev</button>
                    <button class="button secondary" onclick="nextSeed()">Next →</button>
                </div>
                <button class="button tertiary regen-button" onclick="randomSeedAndUpdate()">↻ Random</button>
            </div>

            <!-- Simulation Control -->
            <div class="control-section">
                <h3>Simulation Control</h3>
                <button class="button" id="next-turn-btn" onclick="nextTurn()">Next Turn ▶</button>
            </div>

            <!-- Parameters Section -->
            <div class="control-section">
                <h3>Parameters</h3>
                
                <!-- Processing Speed -->
                <div class="control-group">
                    <label>Processing Speed</label>
                    <div class="slider-container">
                        <input type="range" id="speed" min="2" max="20" step="1" value="8" oninput="updateParam('speed', this.value)">
                        <span class="value-display" id="speed-value">8</span>
                    </div>
                </div>

                <!-- Context Depth -->
                <div class="control-group">
                    <label>Block Complexity</label>
                    <div class="slider-container">
                        <input type="range" id="complexity" min="1" max="10" step="1" value="5" oninput="updateParam('complexity', this.value)">
                        <span class="value-display" id="complexity-value">5</span>
                    </div>
                </div>

                <!-- Resonance -->
                <div class="control-group">
                    <label>Memory Resonance</label>
                    <div class="slider-container">
                        <input type="range" id="resonance" min="50" max="255" step="10" value="150" oninput="updateParam('resonance', this.value)">
                        <span class="value-display" id="resonance-value">150</span>
                    </div>
                </div>
            </div>

            <!-- Colors Section -->
            <div class="control-section">
                <h3>Colors</h3>
                
                <!-- User Color -->
                <div class="control-group">
                    <label>User Input</label>
                    <div class="color-picker-container">
                        <input type="color" id="color1" value="#6a9bcc" onchange="updateColor('color1', this.value)">
                        <span class="color-value" id="color1-value">#6a9bcc</span>
                    </div>
                </div>

                <!-- Model Color -->
                <div class="control-group">
                    <label>Model Response</label>
                    <div class="color-picker-container">
                        <input type="color" id="color2" value="#d97757" onchange="updateColor('color2', this.value)">
                        <span class="color-value" id="color2-value">#d97757</span>
                    </div>
                </div>

                <!-- Scan Color -->
                <div class="control-group">
                    <label>Attention Scan</label>
                    <div class="color-picker-container">
                        <input type="color" id="color3" value="#141413" onchange="updateColor('color3', this.value)">
                        <span class="color-value" id="color3-value">#141413</span>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="control-section">
                <h3>Actions</h3>
                <div class="button-row">
                    <button class="button" onclick="resetParameters()">Reset History</button>
                    <button class="button secondary" onclick="downloadCanvas()">Download</button>
                </div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="canvas-area">
            <div id="canvas-container">
                <div class="loading">Initializing system...</div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════
        // PARAMETERS
        // ═══════════════════════════════════════════════════════════════════════

        let params = {
            seed: 12345,
            speed: 8,
            complexity: 5,
            resonance: 150,
            colorPalette: ['#6a9bcc', '#d97757', '#141413']
        };

        let defaultParams = {...params};

        // ═══════════════════════════════════════════════════════════════════════
        // EXAMPLE MESSAGES
        // ═══════════════════════════════════════════════════════════════════════

        const exampleMessages = [
            { role: 0, text: "How do LLMs remember our conversation?" },
            { role: 1, text: "I don't 'remember' like humans do. Every time you send a message, the entire history is sent back to me." },
            { role: 0, text: "So you read the whole book from the start just to write the next sentence?" },
            { role: 1, text: "Exactly! I re-read everything within my context window to stay consistent." },
            { role: 0, text: "Does that mean longer chats take more power to process?" },
            { role: 1, text: "Yes! The 'prompt' grows with every exchange, requiring more tokens and computation." },
            { role: 0, text: "That's why there's a limit to how much I can say, right?" },
            { role: 1, text: "Correct. Once the history fills my context window, I start losing the earliest parts of our chat." }
        ];

        // ═══════════════════════════════════════════════════════════════════════
        // ALGORITHM: RECURSIVE RESONANCE
        // ═══════════════════════════════════════════════════════════════════════

        let historyBlocks = [];
        let state = 'INIT'; // INIT, SCANNING, GENERATING, IDLE
        let scanY = 0;
        let scanIndex = 0;
        let particles = [];
        let scrollOffset = 0;
        let targetScrollOffset = 0;
        let generatingHeight = 0;

        class Block {
            constructor(role, text, y, h) {
                this.role = role; // 0 = User, 1 = Model
                this.text = text;
                this.y = y;
                this.h = h;
                this.baseColor = role === 0 ? color(params.colorPalette[0]) : color(params.colorPalette[1]);
                this.seed = random(10000);
                this.alpha = 0; // Fade in
                this.scanHighlight = 0;
            }

            draw(yOffset) {
                let drawY = this.y + yOffset;
                
                // Opacity animation
                if (this.alpha < 255) this.alpha += 10;
                
                // Base block
                noStroke();
                let c = color(this.baseColor);
                c.setAlpha(this.alpha);
                fill(c);
                
                rect(100, drawY, width - 200, this.h, 4);
                
                // Draw internal "data" pattern
                push();
                drawingContext.clip();
                noStroke();
                for(let i=0; i < params.complexity * 5; i++) {
                     let nx = noise(this.seed + i * 0.1) * (width - 200) + 100;
                     let ny = noise(this.seed + i * 0.2 + 100) * this.h + drawY;
                     let w = noise(this.seed + i * 0.3) * 50 + 10;
                     fill(255, 20);
                     rect(nx, ny, w, 2);
                }
                
                // Render Text
                fill(255, this.alpha);
                textFont('Poppins');
                textSize(14);
                textAlign(LEFT, TOP);
                textWrap(WORD);
                text(this.text, 120, drawY + 15, width - 240);
                pop();

                // Scan Highlight Effect
                if (this.scanHighlight > 0) {
                    fill(255, this.scanHighlight);
                    rect(100, drawY, width - 200, this.h, 4);
                    this.scanHighlight -= 10;
                }
            }
        }

        function setup() {
            let canvas = createCanvas(800, 800);
            canvas.parent('canvas-container');
            initializeSystem();
            document.querySelector('.loading').style.display = 'none';
        }

        function initializeSystem() {
            randomSeed(params.seed);
            noiseSeed(params.seed);
            
            historyBlocks = [];
            particles = [];
            scrollOffset = 0;
            targetScrollOffset = 0;
            
            // Add initial block (User prompt)
            addBlock(0);
            
            // Start in IDLE state
            state = 'IDLE';
            enableNextButton();
        }

        function nextTurn() {
            if (state === 'IDLE') {
                let nextMsgIndex = historyBlocks.length % exampleMessages.length;
                let nextMsg = exampleMessages[nextMsgIndex];
                
                if (nextMsg.role === 1) {
                    // Model response requires scanning context
                    startScan();
                    disableNextButton();
                } else {
                    // User input appears directly
                    addBlock(nextMsg.role);
                }
            }
        }

        function disableNextButton() {
            let btn = document.getElementById('next-turn-btn');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            btn.style.opacity = '0.7';
            btn.style.cursor = 'not-allowed';
        }

        function enableNextButton() {
            let btn = document.getElementById('next-turn-btn');
            btn.disabled = false;
            btn.textContent = 'Next Turn ▶';
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        }

        function addBlock(role) {
            let msgIndex = historyBlocks.length % exampleMessages.length;
            let msg = exampleMessages[msgIndex];
            
            let lastY = historyBlocks.length > 0 ? historyBlocks[historyBlocks.length - 1].y + historyBlocks[historyBlocks.length - 1].h + 15 : 50;
            
            // Calculate height based on text
            textSize(14);
            let textH = calculateTextHeight(msg.text, width - 240);
            let h = textH + 35; // padding
            
            let b = new Block(msg.role, msg.text, lastY, h);
            historyBlocks.push(b);
            
            // Auto scroll if needed
            if (lastY + h > height - 150) {
                targetScrollOffset = height - 150 - (lastY + h);
            }
        }

        function calculateTextHeight(str, w) {
            let words = str.split(' ');
            let line = '';
            let h = 20; // single line height roughly
            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let testWidth = textWidth(testLine);
                if (testWidth > w && n > 0) {
                    line = words[n] + ' ';
                    h += 20; // add line height
                } else {
                    line = testLine;
                }
            }
            return h;
        }

        function startScan() {
            state = 'SCANNING';
            scanIndex = 0;
            if (historyBlocks.length > 0) {
                scanY = historyBlocks[0].y;
            }
        }

        function draw() {
            background(250, 249, 245);
            
            // Smooth scroll
            scrollOffset = lerp(scrollOffset, targetScrollOffset, 0.1);

            // Draw History
            for (let b of historyBlocks) {
                b.draw(scrollOffset);
            }

            // State Machine
            if (state === 'SCANNING') {
                handleScanning();
            } else if (state === 'GENERATING') {
                handleGenerating();
            }

            // Draw Particles (Information Flow)
            updateAndDrawParticles();
            
            // Draw "Context Window" frame
            drawContextFrame();
            
            // Draw Processing Indicator (GPU/Inference)
            if (state === 'SCANNING') {
                drawProcessingIndicator();
            }
        }

        function drawProcessingIndicator() {
            push();
            let x = width - 120;
            let y = 100;
            
            // Shake effect to show "working hard"
            let shakeX = random(-2, 2);
            let shakeY = random(-2, 2);
            translate(x + shakeX, y + shakeY);
            
            // Chip Body
            noStroke();
            fill(40);
            rectMode(CENTER);
            rect(0, 0, 60, 60, 8);
            
            // Inner Core (Pulsing)
            let pulse = map(sin(frameCount * 0.5), -1, 1, 100, 255);
            fill(params.colorPalette[1]); // Model color
            drawingContext.shadowBlur = 20;
            drawingContext.shadowColor = params.colorPalette[1];
            rect(0, 0, 30, 30, 4);
            drawingContext.shadowBlur = 0;
            
            // "Data Lanes" (blinking lights)
            fill(200);
            if (frameCount % 10 < 5) rect(-15, -20, 4, 8);
            if (frameCount % 15 < 5) rect(0, -20, 4, 8);
            if (frameCount % 7 < 4) rect(15, -20, 4, 8);
            
            if (frameCount % 12 < 6) rect(-15, 20, 4, 8);
            if (frameCount % 8 < 4) rect(0, 20, 4, 8);
            if (frameCount % 10 < 5) rect(15, 20, 4, 8);
            
            // Label
            fill(params.colorPalette[1]);
            noStroke();
            textAlign(CENTER);
            textSize(10);
            textStyle(BOLD);
            text("INFERENCE", 0, 45);
            text("ACTIVE", 0, 57);
            
            // "Re-reading" text floating near the scan line
            pop();
            
            // Floating Label following the scan line
            if (historyBlocks.length > 0) {
                 push();
                 fill(params.colorPalette[2]);
                 textAlign(RIGHT);
                 textSize(12);
                 textStyle(ITALIC);
                 let visualScanY = scanY + scrollOffset;
                 // Only show if visible
                 if (visualScanY > 0 && visualScanY < height) {
                     text("Re-reading history...", width - 100, visualScanY - 10);
                 }
                 pop();
            }
        }

        function handleScanning() {
            if (scanIndex < historyBlocks.length) {
                let b = historyBlocks[scanIndex];
                
                // Move scan head
                scanY += params.speed;
                
                if (scanY > b.y + b.h) {
                    b.scanHighlight = params.resonance;
                    emitParticles(b);
                    scanIndex++;
                    if (scanIndex < historyBlocks.length) {
                        scanY = historyBlocks[scanIndex].y;
                    }
                } else {
                    let visualScanY = scanY + scrollOffset;
                    stroke(params.colorPalette[2]);
                    strokeWeight(2);
                    line(90, visualScanY, width - 90, visualScanY);
                    
                    noStroke();
                    fill(params.colorPalette[2]);
                    drawingContext.shadowBlur = 10;
                    drawingContext.shadowColor = params.colorPalette[2];
                    rect(90, visualScanY - 1, width - 180, 2);
                    drawingContext.shadowBlur = 0;
                }
            } else {
                state = 'GENERATING';
                generatingHeight = 0;
            }
        }

        function handleGenerating() {
            let lastBlock = historyBlocks[historyBlocks.length - 1];
            let startY = lastBlock.y + lastBlock.h + 15;
            let visualY = startY + scrollOffset;
            
            let msgIndex = historyBlocks.length % exampleMessages.length;
            let msg = exampleMessages[msgIndex];
            textSize(14);
            let targetH = calculateTextHeight(msg.text, width - 240) + 35;

            generatingHeight += params.speed * 0.5;
            
            noStroke();
            let c = color(msg.role === 0 ? params.colorPalette[0] : params.colorPalette[1]);
            c.setAlpha(150);
            fill(c);
            rect(100, visualY, width - 200, min(generatingHeight, targetH), 4);
            
            if (generatingHeight >= targetH + 20) {
                addBlock(msg.role);
                state = 'IDLE'; // Go to IDLE instead of SCANNING
                enableNextButton();
            }
        }

        function emitParticles(block) {
            let lastBlock = historyBlocks[historyBlocks.length - 1];
            let targetY = lastBlock.y + lastBlock.h + 15;
            
            for(let i=0; i<8; i++) {
                particles.push({
                    x: random(120, width - 120),
                    y: block.y + random(block.h),
                    tx: random(120, width - 120),
                    ty: targetY,
                    life: 1.0,
                    color: block.baseColor
                });
            }
        }

        function updateAndDrawParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x = lerp(p.x, p.tx, 0.05);
                p.y = lerp(p.y, p.ty, 0.05);
                p.life -= 0.015;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                    continue;
                }
                
                noStroke();
                let c = color(p.color);
                c.setAlpha(p.life * 255);
                fill(c);
                circle(p.x, p.y + scrollOffset, 4);
            }
        }

        function drawContextFrame() {
            noFill();
            stroke(200);
            strokeWeight(1);
            rect(90, 40, width - 180, height - 80, 10);
            
            noStroke();
            fill(150);
            textAlign(RIGHT);
            textFont('Poppins');
            textSize(12);
            text("CONTEXT WINDOW", width - 100, 30);
        }

        function updateParam(name, val) {
            params[name] = parseFloat(val);
            document.getElementById(name + '-value').textContent = val;
        }

        function updateColor(id, val) {
            let idx = parseInt(id.replace('color', '')) - 1;
            params.colorPalette[idx] = val;
            document.getElementById(id + '-value').textContent = val;
        }

        function updateSeed() {
            let val = parseInt(document.getElementById('seed-input').value);
            if (val) {
                params.seed = val;
                initializeSystem();
            }
        }
        
        function previousSeed() {
            document.getElementById('seed-input').value = params.seed - 1;
            updateSeed();
        }
        
        function nextSeed() {
            document.getElementById('seed-input').value = params.seed + 1;
            updateSeed();
        }
        
        function randomSeedAndUpdate() {
            document.getElementById('seed-input').value = Math.floor(Math.random() * 9999);
            updateSeed();
        }

        function resetParameters() {
            params = {...defaultParams};
            params.colorPalette = [...defaultParams.colorPalette];
            initializeSystem();
        }

        function downloadCanvas() {
            saveCanvas('recursive_resonance', 'png');
        }

        window.onload = function() {
            updateSeedDisplay();
        };
        
        function updateSeedDisplay() {
            document.getElementById('seed-input').value = params.seed;
        }

    </script>
</body>
</html>